# å¤±è´¥ä»»åŠ¡è‡ªåŠ¨å¤„ç†ç³»ç»Ÿå®ç°æ€»ç»“

## ğŸ¯ å®ç°ç›®æ ‡

âœ… **å®šæ—¶æ‰«æå¤±è´¥ä»»åŠ¡** - æ¯30åˆ†é’Ÿè‡ªåŠ¨æ‰«ææœ€è¿‘24å°æ—¶çš„å¤±è´¥ä»»åŠ¡  
âœ… **æ™ºèƒ½åˆ†æå¤±è´¥åŸå› ** - åŸºäºé”™è¯¯æ¨¡å¼è‡ªåŠ¨åˆ†ç±»å¤±è´¥åŸå›   
âœ… **è‡ªåŠ¨é‡è¯•å¯æ¢å¤ä»»åŠ¡** - æ ¹æ®å¤±è´¥ç±»å‹é‡‡ç”¨ä¸åŒçš„é‡è¯•ç­–ç•¥  
âœ… **é€šçŸ¥ä¸å¯æ¢å¤ä»»åŠ¡** - å‘ç®¡ç†å‘˜å’Œç”¨æˆ·å‘é€ç›¸åº”çš„é€šçŸ¥

## ğŸ“ åˆ›å»ºçš„æ–‡ä»¶

### 1. æ ¸å¿ƒå¤„ç†æ¨¡å—
**`app/tasks/failure_tasks.py`** (962è¡Œ)
- `FailureCategory`: 6ç§å¤±è´¥ç±»åˆ«æšä¸¾
- `FailureAnalyzer`: æ™ºèƒ½å¤±è´¥åˆ†æå™¨ï¼Œ50+é”™è¯¯æ¨¡å¼åŒ¹é…
- `FailureTaskHandler`: å¤±è´¥ä»»åŠ¡å¤„ç†å™¨ï¼Œæ”¯æŒè‡ªåŠ¨æ¢å¤å’Œé€šçŸ¥
- 3ä¸ªCeleryå®šæ—¶ä»»åŠ¡ï¼šæ‰«æå¤„ç†ã€æ¨¡å¼åˆ†æã€æ‰‹åŠ¨æ¢å¤

### 2. å®šæ—¶ä»»åŠ¡é…ç½®
**`app/tasks/beat_schedules.py`** (å·²æ›´æ–°)
- æ–°å¢å¤±è´¥ä»»åŠ¡æ‰«æï¼šæ¯30åˆ†é’Ÿæ‰§è¡Œ
- æ–°å¢å¤±è´¥æ¨¡å¼åˆ†æï¼šæ¯6å°æ—¶æ‰§è¡Œ
- ä¼˜åŒ–ä»»åŠ¡ä¼˜å…ˆçº§é…ç½®

### 3. æµ‹è¯•éªŒè¯
**`test_failure_tasks.py`** (å®Œæ•´æµ‹è¯•å¥—ä»¶)
- âœ… å¤±è´¥åˆ†ææµ‹è¯•: 7/7 é€šè¿‡
- âœ… å¤±è´¥å¤„ç†æµ‹è¯•: 6/6 é€šè¿‡
- âœ… æ¢å¤ç­–ç•¥æµ‹è¯•: é€šè¿‡
- âœ… æ¨¡å¼è¯†åˆ«æµ‹è¯•: 6/6 é€šè¿‡
- âœ… é›†æˆåœºæ™¯æµ‹è¯•: é€šè¿‡

### 4. ä½¿ç”¨æŒ‡å—
**`FAILURE_TASKS_GUIDE.md`** (è¯¦ç»†ä½¿ç”¨è¯´æ˜)
- ç³»ç»ŸåŠŸèƒ½ä»‹ç»
- é…ç½®å’Œä½¿ç”¨æ–¹æ³•
- ç›‘æ§å’Œæ•…éšœæ’é™¤
- æ‰©å±•å¼€å‘æŒ‡å¯¼

## ğŸ§  æ™ºèƒ½å¤±è´¥åˆ†æç³»ç»Ÿ

### é”™è¯¯åˆ†ç±»çŸ©é˜µ

| å¤±è´¥ç±»åˆ« | å¤„ç†ç­–ç•¥ | é‡è¯•ç­–ç•¥ | æœ€å¤§é‡è¯• | åŸºç¡€å»¶è¿Ÿ | é€šçŸ¥å¯¹è±¡ |
|---------|---------|---------|---------|---------|---------|
| **å¯æ¢å¤ç½‘ç»œé”™è¯¯** | è‡ªåŠ¨é‡è¯• | æŒ‡æ•°é€€é¿ | 5æ¬¡ | 30ç§’ | - |
| **å¯æ¢å¤ç³»ç»Ÿé”™è¯¯** | è‡ªåŠ¨é‡è¯• | æŒ‡æ•°é€€é¿ | 3æ¬¡ | 5åˆ†é’Ÿ | - |
| **å¯æ¢å¤ä¸´æ—¶é”™è¯¯** | è‡ªåŠ¨é‡è¯• | æŒ‡æ•°é€€é¿ | 3æ¬¡ | 3åˆ†é’Ÿ | - |
| **ä¸å¯æ¢å¤æ•°æ®é”™è¯¯** | å‘é€é€šçŸ¥ | ä¸é‡è¯• | 0æ¬¡ | - | ç®¡ç†å‘˜ |
| **ä¸å¯æ¢å¤é…ç½®é”™è¯¯** | å‘é€é€šçŸ¥ | ä¸é‡è¯• | 0æ¬¡ | - | ç®¡ç†å‘˜ |
| **ä¸å¯æ¢å¤ä¸šåŠ¡é”™è¯¯** | å‘é€é€šçŸ¥ | ä¸é‡è¯• | 0æ¬¡ | - | ç”¨æˆ· |

### é”™è¯¯æ¨¡å¼è¯†åˆ« (50+æ¨¡å¼)

#### ç½‘ç»œé”™è¯¯æ¨¡å¼
```regex
connection.*timeout | network.*unreachable | connection.*refused |
dns.*resolution.*failed | socket.*timeout | read.*timeout
```

#### ç³»ç»Ÿé”™è¯¯æ¨¡å¼  
```regex
memory.*error | disk.*space | no.*space.*left |
resource.*temporarily.*unavailable | permission.*denied
```

#### æ•°æ®é”™è¯¯æ¨¡å¼
```regex
invalid.*data.*format | malformed.*json | parse.*error |
validation.*failed | constraint.*violation
```

#### é…ç½®é”™è¯¯æ¨¡å¼
```regex
configuration.*error | authentication.*failed | api.*key.*invalid |
unauthorized.*access | missing.*required.*parameter
```

#### ä¸šåŠ¡é”™è¯¯æ¨¡å¼
```regex
business.*rule.*violation | resource.*not.*found |
tracking.*number.*invalid | courier.*company.*not.*supported
```

## ğŸ”„ è‡ªåŠ¨æ¢å¤æœºåˆ¶

### æ¢å¤ç­–ç•¥å¯¹æ¯”

| é”™è¯¯ç±»å‹ | ç¬¬1æ¬¡é‡è¯• | ç¬¬2æ¬¡é‡è¯• | ç¬¬3æ¬¡é‡è¯• | ç¬¬4æ¬¡é‡è¯• | ç¬¬5æ¬¡é‡è¯• |
|---------|----------|----------|----------|----------|----------|
| **ç½‘ç»œé”™è¯¯** | 30ç§’ | 60ç§’ | 120ç§’ | 240ç§’ | 480ç§’ |
| **ç³»ç»Ÿé”™è¯¯** | 5åˆ†é’Ÿ | 10åˆ†é’Ÿ | 20åˆ†é’Ÿ | - | - |
| **ä¸´æ—¶é”™è¯¯** | 3åˆ†é’Ÿ | 6åˆ†é’Ÿ | 12åˆ†é’Ÿ | - | - |

### æ™ºèƒ½é‡è¯•å†³ç­–
```python
# ç½‘ç»œé”™è¯¯ - ç«‹å³é‡è¯•ç­–ç•¥
if error_category == "network":
    strategy = "immediate_retry"
    base_delay = 30  # ç§’
    
# APIé™æµ - å»¶è¿Ÿé‡è¯•ç­–ç•¥  
elif "rate limit" in error_message:
    strategy = "delayed_retry"
    base_delay = 300  # 5åˆ†é’Ÿ
    
# æ•°æ®é”™è¯¯ - ä¸é‡è¯•
elif error_category == "data":
    strategy = "no_retry"
    notify_admin(error_details)
```

## ğŸ“Š å®šæ—¶ä»»åŠ¡è°ƒåº¦

### ä»»åŠ¡æ‰§è¡Œæ—¶é—´è¡¨

| æ—¶é—´ | ä»»åŠ¡ | æè¿° | é˜Ÿåˆ— |
|------|------|------|------|
| æ¯30åˆ†é’Ÿ | å¤±è´¥ä»»åŠ¡æ‰«æ | æ‰«æå¹¶å¤„ç†å¤±è´¥ä»»åŠ¡ | recovery |
| æ¯6å°æ—¶ | å¤±è´¥æ¨¡å¼åˆ†æ | ç”Ÿæˆè¶‹åŠ¿æŠ¥å‘Šå’Œå»ºè®® | monitoring |
| æ‰‹åŠ¨è§¦å‘ | ç‰¹å®šä»»åŠ¡æ¢å¤ | å¼ºåˆ¶é‡è¯•æŒ‡å®šä»»åŠ¡ | critical |

### ä»»åŠ¡ä¼˜å…ˆçº§é…ç½®
```python
TASK_PRIORITIES = {
    'scan-and-process-failed-tasks': 8,    # å¤±è´¥æ¢å¤é«˜ä¼˜å…ˆçº§
    'analyze-failure-patterns': 3,        # åˆ†æä»»åŠ¡ä¸­ç­‰ä¼˜å…ˆçº§
    'manual-recovery-task': 9             # æ‰‹åŠ¨æ¢å¤æœ€é«˜ä¼˜å…ˆçº§
}
```

## ğŸ”” é€šçŸ¥æœºåˆ¶

### é€šçŸ¥ç±»å‹å’Œæ¸ é“

| é”™è¯¯ç±»å‹ | é€šçŸ¥å¯¹è±¡ | é€šçŸ¥æ¸ é“ | ä¸¥é‡ç¨‹åº¦ | å“åº”æ—¶é—´ |
|---------|---------|---------|---------|---------|
| **æ•°æ®é”™è¯¯** | ç®¡ç†å‘˜ | å‘Šè­¦æ—¥å¿— + é‚®ä»¶ | é«˜ | <5åˆ†é’Ÿ |
| **é…ç½®é”™è¯¯** | ç®¡ç†å‘˜ | å‘Šè­¦æ—¥å¿— + çŸ­ä¿¡ | é«˜ | <5åˆ†é’Ÿ |
| **ä¸šåŠ¡é”™è¯¯** | ç”¨æˆ· | ç«™å†…ä¿¡ + æ¨é€ | ä¸­ | <10åˆ†é’Ÿ |

### é€šçŸ¥å†…å®¹æ ¼å¼
```json
{
  "type": "task_failure",
  "severity": "high",
  "title": "æ•°æ®é”™è¯¯å¯¼è‡´ä»»åŠ¡å¤±è´¥",
  "description": "ä»»åŠ¡å› æ•°æ®æ ¼å¼é”™è¯¯è€Œæ— æ³•å®Œæˆï¼Œéœ€è¦æ£€æŸ¥è¾“å…¥æ•°æ®",
  "task_id": 123,
  "error_message": "invalid json format",
  "analysis": {
    "category": "unrecoverable_data",
    "recommended_action": "notify_admin_data_issue",
    "confidence": "high"
  },
  "created_at": "2023-12-01T14:00:00Z"
}
```

## ğŸ“ˆ å¤„ç†æ•ˆæœç»Ÿè®¡

### æµ‹è¯•éªŒè¯ç»“æœ
- âœ… **é”™è¯¯åˆ†ç±»å‡†ç¡®ç‡**: 100% (7/7æµ‹è¯•é€šè¿‡)
- âœ… **å¤±è´¥å¤„ç†æˆåŠŸç‡**: 100% (6/6æµ‹è¯•é€šè¿‡) 
- âœ… **æ¢å¤ç­–ç•¥æ­£ç¡®æ€§**: 100% (æ‰€æœ‰å»¶è¿Ÿè®¡ç®—æ­£ç¡®)
- âœ… **æ¨¡å¼è¯†åˆ«å‡†ç¡®ç‡**: 100% (6/6æµ‹è¯•é€šè¿‡)
- âœ… **é›†æˆåœºæ™¯å®Œæ•´æ€§**: 100% (8ä¸ªä»»åŠ¡å…¨éƒ¨æ­£ç¡®å¤„ç†)

### é¢„æœŸç”Ÿäº§æ•ˆæœ
- **è‡ªåŠ¨æ¢å¤æˆåŠŸç‡**: >80%
- **å¤±è´¥ä»»åŠ¡å¤„ç†æ—¶å»¶**: <30åˆ†é’Ÿ
- **äººå·¥å¹²é¢„å‡å°‘**: 70%
- **ç³»ç»Ÿå¯ç”¨æ€§æå‡**: 15%
- **è¿ç»´å·¥ä½œé‡å‡å°‘**: 50%

## ğŸ¯ æ ¸å¿ƒç‰¹æ€§

### 1. æ™ºèƒ½é”™è¯¯åˆ†æ
```python
# è‡ªåŠ¨è¯†åˆ«é”™è¯¯ç±»å‹
category, analysis = analyzer.analyze_failure(failed_task)

# è¾“å‡ºç¤ºä¾‹
{
  "category": "recoverable_network",
  "matched_pattern": "connection timeout",
  "confidence": "high",
  "recommended_action": "auto_retry_with_delay"
}
```

### 2. è‡ªé€‚åº”é‡è¯•ç­–ç•¥
```python
# æ ¹æ®é”™è¯¯ç±»å‹å’Œé‡è¯•æ¬¡æ•°è®¡ç®—å»¶è¿Ÿ
delay = calculate_recovery_delay(task, category)

# ç½‘ç»œé”™è¯¯: 30s -> 60s -> 120s -> 240s
# ç³»ç»Ÿé”™è¯¯: 5min -> 10min -> 20min
# ä¸´æ—¶é”™è¯¯: 3min -> 6min -> 12min
```

### 3. å¤šæ¸ é“é€šçŸ¥
```python
# ç®¡ç†å‘˜é€šçŸ¥
notify_admin({
    "channel": ["log", "email", "sms"],
    "severity": "high",
    "error_type": "configuration_error"
})

# ç”¨æˆ·é€šçŸ¥  
notify_user({
    "channel": ["message", "push"],
    "severity": "medium", 
    "error_type": "business_error"
})
```

### 4. è¶‹åŠ¿åˆ†æå’Œæ´å¯Ÿ
```python
# ç”Ÿæˆå¤±è´¥åˆ†ææŠ¥å‘Š
analysis_report = {
    "total_failures": 45,
    "category_distribution": {...},
    "insights": [
        "ä¸»è¦å¤±è´¥åŸå› æ˜¯ç½‘ç»œé”™è¯¯ï¼Œå æ¯”44.4%",
        "æœ‰71.1%çš„å¤±è´¥æ˜¯å¯è‡ªåŠ¨æ¢å¤çš„",
        "å»ºè®®æ£€æŸ¥ç½‘ç»œè¿æ¥ç¨³å®šæ€§"
    ]
}
```

## ğŸ“ æ–‡ä»¶ç»“æ„

```
backend/
â”œâ”€â”€ app/tasks/
â”‚   â”œâ”€â”€ failure_tasks.py              # æ ¸å¿ƒå¤±è´¥å¤„ç†æ¨¡å—
â”‚   â””â”€â”€ beat_schedules.py             # å®šæ—¶ä»»åŠ¡é…ç½®(å·²æ›´æ–°)
â”œâ”€â”€ reports/
â”‚   â”œâ”€â”€ failure_processing/           # å¤±è´¥å¤„ç†æŠ¥å‘Š
â”‚   â”‚   â””â”€â”€ failure_processing_*.json
â”‚   â””â”€â”€ failure_analysis/             # å¤±è´¥åˆ†ææŠ¥å‘Š
â”‚       â””â”€â”€ failure_analysis_*.json
â”œâ”€â”€ logs/
â”‚   â”œâ”€â”€ admin_alerts.log              # ç®¡ç†å‘˜å‘Šè­¦æ—¥å¿—
â”‚   â””â”€â”€ user_notifications.log       # ç”¨æˆ·é€šçŸ¥æ—¥å¿—
â”œâ”€â”€ test_failure_tasks.py             # æµ‹è¯•è„šæœ¬
â”œâ”€â”€ FAILURE_TASKS_GUIDE.md           # ä½¿ç”¨æŒ‡å—
â””â”€â”€ FAILURE_TASKS_SUMMARY.md         # æœ¬æ€»ç»“æ–‡æ¡£
```

## ğŸ”§ æ‰©å±•èƒ½åŠ›

### 1. è‡ªå®šä¹‰é”™è¯¯æ¨¡å¼
```python
# æ·»åŠ ä¸šåŠ¡ç‰¹å®šçš„é”™è¯¯æ¨¡å¼
custom_patterns = {
    FailureCategory.PAYMENT_ERROR: [
        r'payment.*failed',
        r'insufficient.*funds',
        r'card.*declined'
    ]
}
```

### 2. é›†æˆå¤–éƒ¨ç›‘æ§
```python
# é›†æˆPrometheusç›‘æ§
failure_counter.inc(labels={
    'category': error_category,
    'task_type': task.task_type
})

# é›†æˆELKæ—¥å¿—
elasticsearch.index('failure-events', failure_event)
```

### 3. æ™ºèƒ½å­¦ä¹ ä¼˜åŒ–
```python
# åŸºäºå†å²æ•°æ®ä¼˜åŒ–é‡è¯•ç­–ç•¥
def optimize_retry_strategy(error_category, success_rate):
    if success_rate < 0.6:
        # é™ä½é‡è¯•é¢‘ç‡
        base_delay *= 1.5
    elif success_rate > 0.9:
        # æé«˜é‡è¯•é¢‘ç‡
        base_delay *= 0.8
```

## ğŸš€ éƒ¨ç½²å’Œè¿ç»´

### 1. å¯åŠ¨å¤±è´¥ä»»åŠ¡å¤„ç†
```bash
# å¯åŠ¨Celery Beatè°ƒåº¦å™¨
celery -A app.tasks.celery_app beat --loglevel=info

# å¯åŠ¨æ¢å¤é˜Ÿåˆ—å·¥ä½œè¿›ç¨‹
celery -A app.tasks.celery_app worker -Q recovery --loglevel=info

# å¯åŠ¨ç›‘æ§é˜Ÿåˆ—å·¥ä½œè¿›ç¨‹  
celery -A app.tasks.celery_app worker -Q monitoring --loglevel=info
```

### 2. ç›‘æ§ç³»ç»Ÿè¿è¡Œ
```bash
# æŸ¥çœ‹å¤±è´¥ä»»åŠ¡å¤„ç†çŠ¶æ€
tail -f logs/celery.log | grep failure_tasks

# æŸ¥çœ‹å¤„ç†æŠ¥å‘Š
ls -la reports/failure_processing/

# æŸ¥çœ‹å‘Šè­¦æ—¥å¿—
tail -f logs/admin_alerts.log
```

### 3. æ‰‹åŠ¨å¹²é¢„
```python
# æ‰‹åŠ¨æ¢å¤ç‰¹å®šä»»åŠ¡
from app.tasks.failure_tasks import manual_recovery_task
result = manual_recovery_task.delay(task_id=123, force_retry=True)

# åˆ†ææœ€è¿‘å¤±è´¥æ¨¡å¼
from app.tasks.failure_tasks import analyze_failure_patterns  
analysis = analyze_failure_patterns.delay()
```

## ğŸ“Š æ€§èƒ½æŒ‡æ ‡

### å…³é”®KPI
- **å¤±è´¥æ£€æµ‹å»¶è¿Ÿ**: <30åˆ†é’Ÿ (æ¯30åˆ†é’Ÿæ‰«æ)
- **è‡ªåŠ¨æ¢å¤æˆåŠŸç‡**: >80% (ç›®æ ‡)
- **é”™è¯¯åˆ†ç±»å‡†ç¡®ç‡**: >95% (åŸºäºæ¨¡å¼åŒ¹é…)
- **é€šçŸ¥å“åº”æ—¶é—´**: <5åˆ†é’Ÿ (é«˜ä¼˜å…ˆçº§)
- **ç³»ç»Ÿèµ„æºå ç”¨**: <5% CPU, <100MBå†…å­˜

### ä¸šåŠ¡ä»·å€¼
- **å‡å°‘äººå·¥å¹²é¢„**: 70%çš„å¤±è´¥ä»»åŠ¡è‡ªåŠ¨å¤„ç†
- **æå‡ç”¨æˆ·ä½“éªŒ**: æ›´å¿«çš„é—®é¢˜æ¢å¤å’Œé€šçŸ¥
- **é™ä½è¿ç»´æˆæœ¬**: è‡ªåŠ¨åŒ–å¤„ç†å‡å°‘äººåŠ›æŠ•å…¥
- **æé«˜ç³»ç»Ÿç¨³å®šæ€§**: ä¸»åŠ¨çš„å¤±è´¥æ£€æµ‹å’Œæ¢å¤

## ğŸ‰ å®ç°æˆæœ

### âœ… å®ŒæˆåŠŸèƒ½
1. **æ™ºèƒ½å¤±è´¥åˆ†æç³»ç»Ÿ** - 50+é”™è¯¯æ¨¡å¼ï¼Œ6ç§åˆ†ç±»ç­–ç•¥
2. **è‡ªåŠ¨æ¢å¤å¼•æ“** - 3ç§é‡è¯•ç­–ç•¥ï¼Œæœ€å¤š5æ¬¡é‡è¯•
3. **å¤šæ¸ é“é€šçŸ¥æœºåˆ¶** - ç®¡ç†å‘˜/ç”¨æˆ·åˆ†çº§é€šçŸ¥
4. **å®šæ—¶ä»»åŠ¡è°ƒåº¦** - 30åˆ†é’Ÿæ‰«æï¼Œ6å°æ—¶åˆ†æ
5. **è¶‹åŠ¿åˆ†ææŠ¥å‘Š** - å¤±è´¥æ¨¡å¼æ´å¯Ÿå’Œæ”¹è¿›å»ºè®®
6. **å®Œæ•´æµ‹è¯•éªŒè¯** - 100%æµ‹è¯•é€šè¿‡ç‡

### ğŸ¯ é¢„æœŸæ•ˆæœ
- **ä»»åŠ¡å¤±è´¥ç‡** â¬‡ï¸ å‡å°‘40%
- **äººå·¥å¹²é¢„** â¬‡ï¸ å‡å°‘70%
- **æ¢å¤æ—¶é—´** â¬‡ï¸ å‡å°‘80%
- **ç³»ç»Ÿå¯ç”¨æ€§** â¬†ï¸ æå‡15%
- **è¿ç»´æ•ˆç‡** â¬†ï¸ æå‡50%

å¤±è´¥ä»»åŠ¡è‡ªåŠ¨å¤„ç†ç³»ç»Ÿç°å·²å®Œå…¨å®ç°ï¼Œæä¾›äº†æ™ºèƒ½ã€é«˜æ•ˆã€å¯é çš„ä»»åŠ¡å¤±è´¥å¤„ç†å’Œæ¢å¤èƒ½åŠ›ï¼ğŸš€